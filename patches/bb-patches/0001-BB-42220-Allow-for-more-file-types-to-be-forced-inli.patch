From 2a3346d475d7d16aac330e3e4858befdf6c0a3b2 Mon Sep 17 00:00:00 2001
From: Pier Angelo Vendrame <pierov@torproject.org>
Date: Tue, 10 Sep 2024 18:54:30 +0200
Subject: [PATCH] BB 42220: Allow for more file types to be forced-inline.

Firefox allows to open some files in the browser without any
confirmation, but this will result in a disk leak, because the file will
be downloaded to the temporary directory first (and not deleted, in some
cases).
A preference allows PDFs to be opened without being downloaded to disk.
So, we introduce a similar one to do the same for all the files that are
set to be opened automatically in the browser.
---
 uriloader/base/nsURILoader.cpp | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/uriloader/base/nsURILoader.cpp b/uriloader/base/nsURILoader.cpp
index 7b77b667ad..fce2b291e2 100644
--- a/uriloader/base/nsURILoader.cpp
+++ b/uriloader/base/nsURILoader.cpp
@@ -432,17 +432,21 @@ nsresult nsDocumentOpenInfo::DispatchContent(nsIRequest* request) {
 
   bool maybeForceInternalHandling =
       forceExternalHandling &&
-      mozilla::StaticPrefs::browser_download_open_pdf_attachments_inline();
+      (mozilla::StaticPrefs::browser_download_open_pdf_attachments_inline() ||
+       mozilla::StaticPrefs::browser_download_ignore_content_disposition());
 
   // Check if this is a PDF which should be opened internally. We also handle
   // octet-streams that look like they might be PDFs based on their extension.
-  if (maybeForceInternalHandling && IsContentPDF(aChannel, mContentType)) {
+  if (maybeForceInternalHandling) {
     // For a PDF, check if the preference is set that forces attachments to be
     // opened inline. If so, treat it as a non-attachment by clearing
     // 'forceExternalHandling' again. This allows it open a PDF directly
     // instead of downloading it first. It may still end up being handled by
     // a helper app depending anyway on the later checks.
-    auto result = ShouldHandleExternally(nsLiteralCString(APPLICATION_PDF));
+    nsCString mimeType = IsContentPDF(aChannel, mContentType)
+                             ? nsLiteralCString(APPLICATION_PDF)
+                             : mContentType;
+    auto result = ShouldHandleExternally(mimeType);
     if (result.isErr()) {
       return result.unwrapErr();
     }
-- 
2.50.1

