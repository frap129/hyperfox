From 7b43855d1bd6aeae069b73ac721c2723c64d239f Mon Sep 17 00:00:00 2001
From: Pier Angelo Vendrame <pierov@torproject.org>
Date: Tue, 7 May 2024 17:50:20 +0200
Subject: [PATCH] BB 41930: Remove the UI to customize accept_languages.

---
 browser/components/preferences/main.inc.xhtml  |  4 ++++
 browser/components/preferences/main.js         | 18 +++++++++++++++++-
 .../resistfingerprinting/RFPHelper.sys.mjs     | 10 +++++++---
 3 files changed, 28 insertions(+), 4 deletions(-)

diff --git a/browser/components/preferences/main.inc.xhtml b/browser/components/preferences/main.inc.xhtml
index 6e5532ced8..9d23d9e298 100644
--- a/browser/components/preferences/main.inc.xhtml
+++ b/browser/components/preferences/main.inc.xhtml
@@ -406,6 +406,7 @@
   </hbox>
 
   <hbox id="languagesBox" align="center">
+    <!--
     <description flex="1" control="chooseLanguage" data-l10n-id="choose-language-description"/>
     <button id="chooseLanguage"
             is="highlightable-button"
@@ -420,6 +421,9 @@
               languages-customize-select-language.placeholder,
               languages-customize-add.label,
             " />
+    -->
+    <checkbox id="spoofEnglish"
+              data-l10n-id="languages-customize-spoof-english"/>
   </hbox>
 
   <checkbox id="useSystemLocale" hidden="true"
diff --git a/browser/components/preferences/main.js b/browser/components/preferences/main.js
index fe350be72f..a77df4b58f 100644
--- a/browser/components/preferences/main.js
+++ b/browser/components/preferences/main.js
@@ -690,7 +690,23 @@ var gMainPane = {
       "command",
       makeDisableControllingExtension(PREF_SETTING_TYPE, CONTAINERS_KEY)
     );
-    setEventListener("chooseLanguage", "command", gMainPane.showLanguages);
+    // setEventListener("chooseLanguage", "command", gMainPane.showLanguages);
+    {
+      const spoofEnglish = document.getElementById("spoofEnglish");
+      const kPrefSpoofEnglish = "privacy.spoof_english";
+      const preference = Preferences.add({
+        id: kPrefSpoofEnglish,
+        type: "int",
+      });
+      const spoofEnglishChanged = () => {
+        spoofEnglish.checked = preference.value == 2;
+      };
+      spoofEnglishChanged();
+      preference.on("change", spoofEnglishChanged);
+      setEventListener("spoofEnglish", "command", () => {
+        preference.value = spoofEnglish.checked ? 2 : 1;
+      });
+    }
     // TODO (Bug 1817084) Remove this code when we disable the extension
     setEventListener(
       "fxtranslateButton",
diff --git a/toolkit/components/resistfingerprinting/RFPHelper.sys.mjs b/toolkit/components/resistfingerprinting/RFPHelper.sys.mjs
index 1118328b5c..9770219f6c 100644
--- a/toolkit/components/resistfingerprinting/RFPHelper.sys.mjs
+++ b/toolkit/components/resistfingerprinting/RFPHelper.sys.mjs
@@ -175,9 +175,13 @@ class _RFPHelper {
       // Works like disabling accept-language spoofing.
       // fall through
       case 1: // don't spoof
-        // We don't reset intl.accept_languages. Instead, setting
-        // privacy.spoof_english to 1 allows user to change preferred language
-        // settings through Preferences UI.
+        if (this.rfpEnabled) {
+          // When RFP is enabled, we force intl.accept_languages to be the
+          // default, or en-US, en when spoof English is enabled.
+          // See tor-browser#41930.
+          Services.prefs.clearUserPref("intl.accept_languages");
+          Services.prefs.addObserver("intl.accept_languages", this);
+        }
         break;
       case 2: // spoof
         Services.prefs.setCharPref("intl.accept_languages", "en-US, en");
-- 
2.50.1

